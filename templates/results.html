{% extends "base.html" %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {{ pack.title }} - QuizMaster{% endblock %}

{% block header %}
<header class="header header-compact-padding">
    <div class="container">
        <div class="header-content">
            <a href="{{ url_for('packs') }}" class="back-link">
                <i class="fas fa-arrow-left"></i>
                –ù–∞–∑–∞–¥ –∫ –ø–∞–∫–∞–º
            </a>
            <div class="quiz-title">
                <i class="fas fa-chart-bar"></i>
                <span>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∏–∑–∞</span>
            </div>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="results-bg">
    <div class="container">
        <div class="results-container">
            <div class="main-results-card">
                <div class="results-header">
                    <div class="results-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h1>{{ pack.title }}</h1>
                    <p class="pack-description">{{ pack.description }}</p>
                </div>

                <div class="score-section">
                    <div class="main-score">
                        <span class="score-number">{{ quiz_stat.score }}</span>
                        <span class="score-divider">/</span>
                        <span class="total-number">{{ quiz_stat.total_questions }}</span>
                    </div>
                    <div class="percentage-score">
                        {% if quiz_stat.total_questions > 0 %}
                            {{ ((quiz_stat.score / quiz_stat.total_questions) * 100) | round | int }}% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                        {% else %}
                            0% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                        {% endif %}
                    </div>
                    <div class="completion-date">
                        –ó–∞–≤–µ—Ä—à–µ–Ω–æ: {{ quiz_stat.completed_at.strftime('%d.%m.%Y –≤ %H:%M') }}
                    </div>
                </div>

                <div class="performance-badge">
                    {% set percentage = ((quiz_stat.score / quiz_stat.total_questions) * 100) | round | int %}
                    {% if percentage >= 90 %}
                        <div class="badge excellent">
                            <i class="fas fa-star"></i>
                            <span>–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!</span>
                        </div>
                    {% elif percentage >= 70 %}
                        <div class="badge good">
                            <i class="fas fa-thumbs-up"></i>
                            <span>–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!</span>
                        </div>
                    {% elif percentage >= 50 %}
                        <div class="badge average">
                            <i class="fas fa-check"></i>
                            <span>–ù–µ–ø–ª–æ—Ö–æ!</span>
                        </div>
                    {% else %}
                        <div class="badge needs-improvement">
                            <i class="fas fa-redo"></i>
                            <span>–ú–æ–∂–Ω–æ –ª—É—á—à–µ!</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="pack-statistics-card">
                <h3>
                    <i class="fas fa-chart-line"></i>
                    –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —ç—Ç–æ–º—É –ø–∞–∫—É
                </h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">{{ pack_stats.total_attempts }}</div>
                        <div class="stat-label">–ü–æ–ø—ã—Ç–æ–∫</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ pack_stats.best_score }}/{{ pack_stats.total_questions_in_pack }}</div>
                        <div class="stat-label">–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ pack_stats.average_score | round(1) }}</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                    </div>
                    <div class="stat-item">
                        {% if pack_stats.total_questions_in_pack > 0 %}
                            <div class="stat-value">{{ ((pack_stats.best_score / pack_stats.total_questions_in_pack) * 100) | round | int }}%</div>
                        {% else %}
                            <div class="stat-value">0%</div>
                        {% endif %}
                        <div class="stat-label">–õ—É—á—à–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å</div>
                    </div>
                </div>
            </div>

            <div class="detailed-results-card">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-list-check"></i>
                        –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    </h3>
                    <button class="toggle-details-btn" onclick="toggleDetails()">
                        <span id="toggle-text">–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏</span>
                        <i class="fas fa-chevron-down" id="toggle-icon"></i>
                    </button>
                </div>

                <div class="questions-summary">
                    <div class="summary-item correct">
                        <i class="fas fa-check-circle"></i>
                        <span>{{ quiz_stat.score }} –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö</span>
                    </div>
                    <div class="summary-item incorrect">
                        <i class="fas fa-times-circle"></i>
                        <span>{{ quiz_stat.total_questions - quiz_stat.score }} –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö</span>
                    </div>
                </div>

                <div class="questions-details" id="questions-details" style="display: none;">
                    {% for result in results_data %}
                    <div class="question-result {% if result.is_correct %}correct{% else %}incorrect{% endif %}">
                        <div class="question-header">
                            <div class="question-number">
                                –í–æ–ø—Ä–æ—Å {{ loop.index }}
                                {% if result.is_correct %}
                                    <i class="fas fa-check-circle correct-icon"></i>
                                {% else %}
                                    <i class="fas fa-times-circle incorrect-icon"></i>
                                {% endif %}
                            </div>
                        </div>

                        <div class="question-text">{{ result.question_text }}</div>

                        <div class="answers-review">
                            {% for option_text in result.options %}
                            <div class="answer-option
                                {% if loop.index0 == result.user_selected_index and not result.is_correct %}user-wrong-answer{% endif %}
                                {% if loop.index0 == result.user_selected_index and result.is_correct %}user-correct-answer{% endif %}">

                                <span class="option-letter">{{ (65 + loop.index0) | chr }}.</span>
                                <span class="option-text">{{ option_text }}</span>

                                {% if loop.index0 == result.user_selected_index and result.is_correct %}
                                    <i class="fas fa-check answer-indicator correct"></i>
                                {% endif %}

                                {% if loop.index0 == result.user_selected_index and not result.is_correct %}
                                    <i class="fas fa-times answer-indicator incorrect"></i>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="action-buttons">
                <a href="{{ url_for('quiz', pack_id=pack.id) }}" class="btn btn-primary">
                    <i class="fas fa-redo"></i>
                    –ü—Ä–æ–π—Ç–∏ —Å–Ω–æ–≤–∞
                </a>
                <a href="{{ url_for('packs') }}" class="btn btn-outline">
                    <i class="fas fa-th-large"></i>
                    –î—Ä—É–≥–∏–µ –ø–∞–∫–∏
                </a>
                <a href="{{ url_for('profile') }}" class="btn btn-secondary">
                    <i class="fas fa-user"></i>
                    –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
                </a>
            </div>

            <div class="share-section">
                <h4>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º</h4>
                <div class="share-buttons">
                    <button class="share-btn" onclick="shareResult()">
                        <i class="fas fa-share"></i>
                        –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                    </button>
                    <button class="share-btn" onclick="copyResult()">
                        <i class="fas fa-copy"></i>
                        –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{# –ü–ï–†–ï–ú–ï–©–ï–ù–û: –°–∫—Ä–∏–ø—Ç—ã –∏ —Å—Ç–∏–ª–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ content (–∏–ª–∏ –¥—Ä—É–≥–∏—Ö –±–ª–æ–∫–æ–≤, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –≤ base.html) #}
<script>
function toggleDetails() {
    const details = document.getElementById('questions-details');
    const toggleText = document.getElementById('toggle-text');
    const toggleIcon = document.getElementById('toggle-icon');

    if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'block';
        toggleText.textContent = '–°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏';
        toggleIcon.className = 'fas fa-chevron-up';
    } else {
        details.style.display = 'none';
        toggleText.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏';
        toggleIcon.className = 'fas fa-chevron-down';
    }
}

function shareResult() {
    const score = {{ quiz_stat.score }};
    const total = {{ quiz_stat.total_questions }};
    const percentage = {{ ((quiz_stat.score / quiz_stat.total_questions) * 100) | round | int }};
    const packTitle = "{{ pack.title }}";

    const text = `–Ø –ø—Ä–æ—à–µ–ª –∫–≤–∏–∑ "${packTitle}" –∏ –Ω–∞–±—Ä–∞–ª ${score}/${total} –±–∞–ª–ª–æ–≤ (${percentage}%)! üéØ`;

    if (navigator.share) {
        navigator.share({
            title: '–ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ QuizMaster',
            text: text,
            url: window.location.href
        });
    } else {
        copyResult();
        alert('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    }
}

function copyResult() {
    const score = {{ quiz_stat.score }};
    const total = {{ quiz_stat.total_questions }};
    const percentage = {{ ((quiz_stat.score / quiz_stat.total_questions) * 100) | round | int }};
    const packTitle = "{{ pack.title }}";

    const text = `–Ø –ø—Ä–æ—à–µ–ª –∫–≤–∏–∑ "${packTitle}" –∏ –Ω–∞–±—Ä–∞–ª ${score}/${total} –±–∞–ª–ª–æ–≤ (${percentage}%)! üéØ\n\n–ü–æ–ø—Ä–æ–±—É–π –∏ —Ç—ã: ${window.location.origin}`;

    navigator.clipboard.writeText(text).then(() => {
        const notification = document.createElement('div');
        notification.className = 'copy-notification';
        notification.textContent = '–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!';
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    });
}
</script>
{% endblock %}