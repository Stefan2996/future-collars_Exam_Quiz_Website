{% extends "base.html" %}

{% block title %}Results: {{ pack.title }} - QuizMaster{% endblock %}

{% block header %}
<header class="header header-compact-padding">
    <div class="container">
        <div class="header-content">
            <a href="{{ url_for('packs.packs') }}" class="back-link">
                <i class="fas fa-arrow-left"></i>
                Back to Packs
            </a>
            <div class="quiz-title">
                <i class="fas fa-chart-bar"></i>
                <span>Quiz Results</span>
            </div>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="results-bg">
    <div class="container">
        <div class="results-container">
            <div class="main-results-card">
                <div class="results-header">
                    <div class="results-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h1>{{ pack.title }}</h1>
                    <p class="pack-description">{{ pack.description }}</p>
                </div>

                <div class="score-section">
                    <div class="main-score">
                        <span class="score-number">{{ quiz_stat.score }}</span>
                        <span class="score-divider">/</span>
                        <span class="total-number">{{ quiz_stat.total_questions }}</span>
                    </div>
                    <div class="percentage-score">
                        {% if quiz_stat.total_questions > 0 %}
                            {{ ((quiz_stat.score / quiz_stat.total_questions) * 100) | round | int }}% correct answers
                        {% else %}
                            0% correct answers
                        {% endif %}
                    </div>
                    <div class="completion-date">
                        Completed: {{ quiz_stat.completed_at.strftime('%d.%m.%Y at %H:%M') }}
                    </div>
                </div>

                <div class="performance-badge">
                    {% set percentage = ((quiz_stat.score / quiz_stat.total_questions) * 100) | round | int %}
                    {% if percentage >= 90 %}
                        <div class="badge excellent">
                            <i class="fas fa-star"></i>
                            <span>Excellent Result!</span>
                        </div>
                    {% elif percentage >= 70 %}
                        <div class="badge good">
                            <i class="fas fa-thumbs-up"></i>
                            <span>Good Result!</span>
                        </div>
                    {% elif percentage >= 50 %}
                        <div class="badge average">
                            <i class="fas fa-check"></i>
                            <span>Not Bad!</span>
                        </div>
                    {% else %}
                        <div class="badge needs-improvement">
                            <i class="fas fa-redo"></i>
                            <span>Can Do Better!</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="pack-statistics-card">
                <h3>
                    <i class="fas fa-chart-line"></i>
                    Your Statistics for This Pack
                </h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">{{ pack_stats.total_attempts }}</div>
                        <div class="stat-label">Attempts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ pack_stats.best_score }}/{{ pack_stats.total_questions_in_pack }}</div>
                        <div class="stat-label">Best Score</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ pack_stats.average_score | round(1) }}</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                    <div class="stat-item">
                        {% if pack_stats.total_questions_in_pack > 0 %}
                            <div class="stat-value">{{ ((pack_stats.best_score / pack_stats.total_questions_in_pack) * 100) | round | int }}%</div>
                        {% else %}
                            <div class="stat-value">0%</div>
                        {% endif %}
                        <div class="stat-label">Best Accuracy</div>
                    </div>
                </div>
            </div>

            <div class="detailed-results-card">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-list-check"></i>
                        Detailed Results
                    </h3>
                    <button class="toggle-details-btn" onclick="toggleDetails()">
                        <span id="toggle-text">Show Details</span>
                        <i class="fas fa-chevron-down" id="toggle-icon"></i>
                    </button>
                </div>

                <div class="questions-summary">
                    <div class="summary-item correct">
                        <i class="fas fa-check-circle"></i>
                        <span>{{ quiz_stat.score }} correct</span>
                    </div>
                    <div class="summary-item incorrect">
                        <i class="fas fa-times-circle"></i>
                        <span>{{ quiz_stat.total_questions - quiz_stat.score }} incorrect</span>
                    </div>
                </div>

                <div class="questions-details" id="questions-details" style="display: none;">
                    {% for result in results_data %}
                    <div class="question-result {% if result.is_correct %}correct{% else %}incorrect{% endif %}">
                        <div class="question-header">
                            <div class="question-number">
                                Question {{ loop.index }}
                                {% if result.is_correct %}
                                    <i class="fas fa-check-circle correct-icon"></i>
                                {% else %}
                                    <i class="fas fa-times-circle incorrect-icon"></i>
                                {% endif %}
                            </div>
                        </div>

                        <div class="question-text">{{ result.question_text }}</div>

                        <div class="answers-review">
                            {% for option_text in result.options %}
                            <div class="answer-option
                                {% if loop.index0 == result.user_selected_index and not result.is_correct %}user-wrong-answer{% endif %}
                                {% if loop.index0 == result.user_selected_index and result.is_correct %}user-correct-answer{% endif %}">

                                <span class="option-letter">{{ (65 + loop.index0) | chr }}.</span>
                                <span class="option-text">{{ option_text }}</span>

                                {% if loop.index0 == result.user_selected_index and result.is_correct %}
                                    <i class="fas fa-check answer-indicator correct"></i>
                                {% endif %}

                                {% if loop.index0 == result.user_selected_index and not result.is_correct %}
                                    <i class="fas fa-times answer-indicator incorrect"></i>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="action-buttons">
                <a href="{{ url_for('quiz.quiz', pack_id=pack.id) }}" class="btn btn-primary">
                    <i class="fas fa-redo"></i>
                    Retake Quiz
                </a>
                <a href="{{ url_for('packs.packs') }}" class="btn btn-outline">
                    <i class="fas fa-th-large"></i>
                    Other Packs
                </a>
                <a href="{{ url_for('auth.profile') }}" class="btn btn-secondary">
                    <i class="fas fa-user"></i>
                    My Profile
                </a>
            </div>

            <div class="share-section">
                <h4>Share Result</h4>
                <div class="share-buttons">
                    <button class="share-btn" onclick="shareResult()">
                        <i class="fas fa-share"></i>
                        Share
                    </button>
                    <button class="share-btn" onclick="copyResult()">
                        <i class="fas fa-copy"></i>
                        Copy
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{# Added hidden JSON tag to pass data to JavaScript #}
<script id="results-data" type="application/json">
    {{ results_data_json | safe }}
</script>

{# Include external JavaScript file #}
<script src="{{ url_for('static', filename='js/results.js') }}"></script>
{% endblock %}